name: Convert Markdown to PDF

on:
  push:
    paths:
      - '**.md'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            fonts-noto-cjk \
            fonts-noto-color-emoji \
            fonts-noto-extra
          fc-cache -f -v

      - name: Convert Markdown to PDF (Safe Mode)
        run: |
          # 设置安全解析模式
          IFS=$'\n'
          mkdir -p ./output_pdfs
          
          # 使用 find 的安全模式
          find . -name "*.md" -type f -print0 | while IFS= read -r -d '' md_file; do
            echo "Processing: $md_file"
            
            # 生成安全文件名
            safe_name=$(basename "$md_file" .md | tr ' ' '_' | tr -cd '[:alnum:]._-')
            pdf_file="./output_pdfs/${safe_name}.pdf"
            
            # 显示调试信息
            echo "Input file exists? $(test -f "$md_file" && echo YES || echo NO)"
            echo "Output path: $pdf_file"
            
            # 执行转换
            pandoc "$md_file" \
              --pdf-engine=xelatex \
              -V mainfont="Noto Sans CJK SC" \
              -V geometry:margin=1in \
              -o "$pdf_file"
          done

      - name: Commit and push PDFs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "PDF Generator"
          git config --global user.email "pdf-generator@users.noreply.github.com"
          git config --global core.quotepath false
          
          git add ./output_pdfs/
          git commit -m "[skip ci] Auto-generated PDFs (safe mode)"
          git pull --rebase
          git push origin HEAD:main
name: Convert Markdown to PDF

on:
  push:
    paths:
      - '**.md'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            fonts-noto-cjk \
            fonts-noto-color-emoji \
            fonts-noto-extra
          
          # 强制刷新字体缓存
          fc-cache -f -v
          mkdir -p ~/.config/fontconfig
          cp .fonts.conf ~/.config/fontconfig/

      - name: Convert Markdown to PDF (Fixed)
        run: |
          find . -name "*.md" -type f | while read -r md_file; do
            pdf_file="${md_file%.md}.pdf"
            pandoc "$md_file" \
              --pdf-engine=xelatex \          # 唯一指定 PDF 引擎
              -V mainfont="Noto Sans CJK SC" \
              -V sansfont="Noto Sans CJK SC" \
              -V monofont="Noto Sans Mono CJK SC" \
              -V geometry:margin=1in \
              --variable=emoji-font:"Noto Color Emoji" \
              -o "$pdf_file"
          done

      - name: Commit and push PDFs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global core.quotepath false
          
          git add .
          git commit -m "[skip ci] Auto-generated PDFs"
          git pull --rebase
          git push origin HEAD:main
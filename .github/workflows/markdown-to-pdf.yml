name: Convert Markdown to PDF

on:
  push:
    paths:
      - '**.md'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex \
            fonts-noto-cjk fonts-noto-color-emoji

      - name: Convert Markdown to PDF
        run: |
          find . -name "*.md" -type f | while read -r md_file; do
            pdf_file="${md_file%.md}.pdf"
            pandoc "$md_file" \
              --pdf-engine=xelatex \
              -V mainfont="Noto Sans CJK SC" \
              -V sansfont="Noto Sans CJK JP" \
              -V monofont="Noto Sans Mono CJK KR" \
              -V fontsize=12pt \
              -V geometry:margin=1in \
              --variable=emoji-font:"Noto Color Emoji" \
              --metadata=lang:"zh-CN" \
              -o "$pdf_file"
          done

      - name: Commit and push PDFs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 配置 Git 使用 HTTPS 认证
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic $(echo -n x-access-token:$GITHUB_TOKEN | base64)"
          
          # 修复文件名编码问题
          git config --global core.quotepath false
          
          git add .
          git status
          git commit -m "[skip ci] Auto-generated PDFs from Markdown"
          git pull --rebase
          git push origin HEAD:main
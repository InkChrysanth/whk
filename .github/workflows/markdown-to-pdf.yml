name: Auto PDF Converter

on:
  push:
    paths:
      - '**.md'

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ========== SSH ç¯å¢ƒé…ç½® ==========
      - name: é…ç½® SSH åŸºç¡€ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client git
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

      # ========== ä»£ç æ£€å‡º ==========
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          path: src
          fetch-depth: 0

      # ========== ä¾èµ–å®‰è£… ==========
      - name: å®‰è£…è½¬æ¢ä¾èµ–
        run: |
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-latex-recommended \
            fonts-noto-cjk \
            fonts-noto-color-emoji \
            fonts-arphic-ukai

          # éªŒè¯å­—ä½“å®‰è£…
          fc-list : family | grep -E 'Noto|AR PL'

      # ========== LaTeX æ¨¡æ¿ ==========
      - name: é…ç½® LaTeX æ¨¡æ¿
        run: |
          mkdir -p .latex
          cat << 'EOF' > .latex/template.tex
          \documentclass{article}
          \usepackage{xeCJK}
          \setCJKmainfont{Noto Sans CJK SC}[
            Path=/usr/share/fonts/opentype/noto/,
            BoldFont=NotoSansCJK-Bold,
            ItalicFont=NotoSansCJK-Thin
          ]
          \usepackage{emoji}
          \setemojifont{Noto Color Emoji}[Renderer=HarfBuzz]
          \usepackage{geometry}
          \geometry{a4paper, margin=1in}
          \begin{document}
          $body$
          \end{document}
          EOF

      # ========== æ–‡ä»¶è½¬æ¢ ==========
      - name: è½¬æ¢ Markdown åˆ° PDF
        working-directory: ./src
        run: |
          mkdir -p output_pdfs
          
          find . -name "*.md" -print0 | while IFS= read -r -d '' file; do
            # ç”Ÿæˆå®‰å…¨æ–‡ä»¶å
            safe_name=$(basename "$file" .md | iconv -f utf8 -t ascii//TRANSLIT | tr ' ' '_')
            
            echo "â–¸ æ­£åœ¨è½¬æ¢: $file â†’ output_pdfs/${safe_name}.pdf"
            
            pandoc "$file" \
              --template=../.latex/template.tex \
              --pdf-engine=xelatex \
              --resource-path=$(dirname "$file") \
              -o "output_pdfs/${safe_name}.pdf" \
              --verbose 2>&1 | tee pandoc.log

            # å¤±è´¥æ—¶ä¸­æ–­
            if [ ! -f "output_pdfs/${safe_name}.pdf" ]; then
              echo "âŒ è½¬æ¢å¤±è´¥"
              cat pandoc.log
              exit 1
            fi
          done

      # ========== æäº¤å’Œæ¨é€ ==========
      - name: æ¨é€ç”Ÿæˆçš„ PDF
        working-directory: ./src
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SSH_KEY: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        run: |
          # é…ç½® SSH å¯†é’¥
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts

          # é…ç½® Git èº«ä»½
          git config --global user.name "PDF Bot"
          git config --global user.email "pdf-bot@users.noreply.github.com"
          git config --global core.quotepath false

          # æ·»åŠ å¹¶æäº¤æ›´æ”¹
          git add output_pdfs/
          if ! git diff-index --quiet HEAD --; then
            git commit -m "[PDF] Auto-generated $(date +'%Y%m%d-%H%M%S')"
            git pull --rebase origin main
            git push origin HEAD:main
            echo "âœ… å·²æˆåŠŸæ¨é€ PDF æ–‡ä»¶"
          else
            echo "ğŸŸ¢ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          fi

          # æ¸…ç†å¯†é’¥
          rm -f ~/.ssh/id_ed25519

      # ========== æ—¥å¿—æ”¶é›† ==========
      - name: ä¸Šä¼ è°ƒè¯•æ—¥å¿—
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: debug-artifacts
          path: |
            src/pandoc.log
            src/output_pdfs/*.pdf